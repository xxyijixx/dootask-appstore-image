name: Export Docker Image to Release

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: '选择要导出的镜像'
        required: true
        type: choice
        options:
          - kuaifan/dootask-ai
          - kuaifan/minder
          - kuaifan/doookr
      image_tag:
        description: '镜像版本/标签 (例如: latest, v1.0.0)'
        required: true
        type: string
        default: 'latest'

jobs:
  export-and-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub (if needed)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true

      - name: Pull Docker image
        run: |
          docker pull ${{ inputs.image_name }}:${{ inputs.image_tag }}

      - name: Export Docker image to tar
        id: export
        run: |
          IMAGE_NAME="${{ inputs.image_name }}"
          IMAGE_TAG="${{ inputs.image_tag }}"
          # 替换 / 为 - 作为文件名
          FILENAME=$(echo "${IMAGE_NAME}" | tr '/' '-')
          TAR_FILE="${FILENAME}-${IMAGE_TAG}.tar"
          TAR_GZ_FILE="${FILENAME}-${IMAGE_TAG}.tar.gz"
          
          # 根据镜像名称生成 release tag（去掉 kuaifan/ 前缀）
          RELEASE_TAG=$(echo "${IMAGE_NAME}" | sed 's|kuaifan/||')
          
          docker save ${IMAGE_NAME}:${IMAGE_TAG} -o ${TAR_FILE}
          echo "已导出镜像: ${TAR_FILE}"
          echo "Release Tag: ${RELEASE_TAG}"
          ls -lh ${TAR_FILE}
          
          # 生成 artifact 名称（替换 / 为 -）
          ARTIFACT_NAME="${FILENAME}-${IMAGE_TAG}"
          
          # 保存文件名和 release tag 到输出，供后续步骤使用
          echo "tar_file=${TAR_FILE}" >> $GITHUB_OUTPUT
          echo "tar_gz_file=${TAR_GZ_FILE}" >> $GITHUB_OUTPUT
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT

      - name: Compress tar file
        run: |
          gzip ${{ steps.export.outputs.tar_file }}
          echo "已压缩: ${{ steps.export.outputs.tar_gz_file }}"
          ls -lh ${{ steps.export.outputs.tar_gz_file }}

      - name: Create or update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.export.outputs.release_tag }}
          name: ${{ steps.export.outputs.release_tag }} - Docker Images
          files: |
            ${{ steps.export.outputs.tar_gz_file }}
          draft: false
          prerelease: false
          update: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.export.outputs.artifact_name }}
          path: ${{ steps.export.outputs.tar_gz_file }}
          retention-days: 7

